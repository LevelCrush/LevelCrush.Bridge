#!/bin/bash
# Pre-commit hook to check for potential credential leaks

# Patterns that might indicate credentials
PATTERNS=(
    # Discord
    "DISCORD_CLIENT_SECRET=\S+"
    "DISCORD_TOKEN=\S+"
    # Generic API keys and secrets
    "API_KEY=\S+"
    "API_SECRET=\S+"
    "SECRET_KEY=\S+"
    "CLIENT_SECRET=\S+"
    "PRIVATE_KEY=\S+"
    # Database credentials
    "DB_PASSWORD=\S+"
    "DATABASE_PASSWORD=\S+"
    # JWT secrets
    "JWT_SECRET=\S+"
    # AWS
    "AWS_SECRET_ACCESS_KEY=\S+"
    "AWS_ACCESS_KEY_ID=\S+"
)

# Check for .env files (only .env.example and .env.*.example are allowed)
ENV_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.env' | grep -v -E '\.env\.example$|\.env\.[^.]+\.example$')
if [ ! -z "$ENV_FILES" ]; then
    echo "❌ ERROR: Attempting to commit .env files that are not .example files:"
    echo "$ENV_FILES"
    echo ""
    echo "Only .env.example and .env.*.example files should be committed."
    echo "Please remove these files from your commit and add them to .gitignore."
    echo ""
    exit 1
fi

# Files to check for credentials (exclude example files)
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -v -E '\.example$|\.sample$|\.template$')

if [ -z "$FILES" ]; then
    exit 0
fi

# Check each file for patterns
for FILE in $FILES; do
    for PATTERN in "${PATTERNS[@]}"; do
        if grep -E "$PATTERN" "$FILE" > /dev/null 2>&1; then
            echo "⚠️  WARNING: Potential credential found in $FILE"
            echo "   Pattern matched: $PATTERN"
            echo ""
            echo "   If this is intentional (e.g., in an example file), you can:"
            echo "   1. Use placeholder values like 'your-secret-here'"
            echo "   2. Add the file to .gitignore"
            echo "   3. Use git commit --no-verify to bypass this check"
            echo ""
            exit 1
        fi
    done
done

exit 0